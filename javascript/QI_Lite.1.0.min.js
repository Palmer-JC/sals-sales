/* Copyright Â© 2022 Jeffrey Palmer (MIT License) */
"use strict";var QI_Lite;(function(QI_Lite){const VARIABLE_ADVANCE_AMT=1e3/60;class TimelineControl{static initialize(scene){if(!TimelineControl._afterRenderAssigned){scene.registerAfterRender(TimelineControl._manualAdvanceAfterRender);TimelineControl._scene=scene;TimelineControl._afterRenderAssigned=true;BABYLON.Tools.Log(`QI Lite Timeline Control system initialized, version: ${QI_Lite.PovProcessor.Version}`)}}static change(isRealTime,rateIfManual=24){TimelineControl._isRealtime=isRealTime;TimelineControl._manualFrameRate=rateIfManual}static _manualAdvanceAfterRender(){const elapsed=BABYLON.Tools.Now-TimelineControl._lastRun;if(TimelineControl._isRealtime){TimelineControl._privelegedNow+=elapsed*TimelineControl._speed}else TimelineControl._privelegedNow+=1e3/TimelineControl._manualFrameRate;if(TimelineControl._resumeQueued||elapsed>TimelineControl.CHANGED_TABS_THRESHOLD){TimelineControl._systemPaused=TimelineControl._resumeQueued=false;TimelineControl._systemResumeTime=TimelineControl._now}if(!TimelineControl._systemPaused&&!TimelineControl._privledgedMode){TimelineControl._frameID++;if(TimelineControl._isRealtime){TimelineControl._now+=elapsed*TimelineControl._speed}else TimelineControl._now+=1e3/TimelineControl._manualFrameRate}TimelineControl._lastRun=BABYLON.Tools.Now}static get manualFrameRate(){return TimelineControl._manualFrameRate}static get isRealtime(){return TimelineControl._isRealtime}static get Now(){return TimelineControl._now}static get PrivilegedNow(){return TimelineControl._privelegedNow}static get FrameID(){return TimelineControl._frameID}static get Speed(){return TimelineControl._speed}static get scene(){return TimelineControl._scene}static get frameAdvanceAmt(){return TimelineControl._speed*(TimelineControl._isRealtime?VARIABLE_ADVANCE_AMT:1e3/TimelineControl._manualFrameRate)}static set Speed(newSpeed){if(!TimelineControl._isRealtime){BABYLON.Tools.Error("TimelineControl: changing speed only supported for realtime mode");return}TimelineControl._speed=newSpeed;const tracks=TimelineControl._scene.mainSoundTrack.soundCollection;for(const track of tracks){track.setPlaybackRate(newSpeed)}}static get isSystemPaused(){return TimelineControl._systemPaused}static pauseSystem(needPrivilegedSound){TimelineControl._systemPaused=true;TimelineControl._scene.audioEnabled=needPrivilegedSound}static get SystemResumeTime(){return TimelineControl._systemResumeTime}static resumeSystem(){TimelineControl._resumeQueued=true;TimelineControl._scene.audioEnabled=true}static get inPrivledgedMode(){return TimelineControl._privledgedMode}static set inPrivledgedMode(value){TimelineControl._privledgedMode=value}}TimelineControl._isRealtime=true;TimelineControl._now=BABYLON.Tools.Now;TimelineControl._privelegedNow=BABYLON.Tools.Now;TimelineControl._lastRun=BABYLON.Tools.Now;TimelineControl._frameID=0;TimelineControl._speed=1;TimelineControl.CHANGED_TABS_THRESHOLD=500;TimelineControl._systemResumeTime=0;TimelineControl._systemPaused=false;TimelineControl._resumeQueued=false;TimelineControl._privledgedMode=false;QI_Lite.TimelineControl=TimelineControl;QI_Lite.Assert=true})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class Pace{constructor(_mode=Pace.MODE_IN){this._mode=_mode}getCompletionMilestone(currentDurationRatio){if(currentDurationRatio<=0)return 0;else if(currentDurationRatio>=1)return 1;switch(this._mode){case Pace.MODE_IN:return this._compute(currentDurationRatio);case Pace.MODE_OUT:return 1-this._compute(1-currentDurationRatio)}if(currentDurationRatio>=.5){return(1-this._compute((1-currentDurationRatio)*2))*.5+.5}return this._compute(currentDurationRatio*2)*.5}getClassName(){return"Pace"}toScript(){let ret=`new QI_Lite.${this.getClassName}(`;if(this._mode===Pace.MODE_OUT)ret+="QI_Lite.Pace.MODE_OUT";else if(this._mode===Pace.MODE_INOUT)ret+="QI_Lite.Pace.MODE_INOUT";return ret+")"}_compute(currentDurationRatio){return 0}}Pace.MODE_IN=0;Pace.MODE_OUT=1;Pace.MODE_INOUT=2;QI_Lite.Pace=Pace;class CirclePace extends Pace{_compute(currentDurationRatio){currentDurationRatio=Math.max(0,Math.min(1,currentDurationRatio));return 1-Math.sqrt(1-currentDurationRatio*currentDurationRatio)}getClassName(){return"CirclePace"}}QI_Lite.CirclePace=CirclePace;class CubicPace extends Pace{_compute(currentDurationRatio){return currentDurationRatio*currentDurationRatio*currentDurationRatio}getClassName(){return"CubicPace"}}QI_Lite.CubicPace=CubicPace;class ElasticPace extends Pace{constructor(oscillations=3,springiness=3,mode=Pace.MODE_IN){super(mode);this.oscillations=oscillations;this.springiness=springiness}_compute(currentDurationRatio){let num2;const num3=Math.max(0,this.oscillations);const num=Math.max(0,this.springiness);if(num==0){num2=currentDurationRatio}else{num2=(Math.exp(num*currentDurationRatio)-1)/(Math.exp(num)-1)}return num2*Math.sin((6.283185307179586*num3+1.5707963267948966)*currentDurationRatio)}getClassName(){return"ElasticPace"}}QI_Lite.ElasticPace=ElasticPace;class ExponentialPace extends Pace{constructor(exponent=2,mode=Pace.MODE_IN){super(mode);this.exponent=exponent}_compute(currentDurationRatio){if(this.exponent<=0){return currentDurationRatio}return(Math.exp(this.exponent*currentDurationRatio)-1)/(Math.exp(this.exponent)-1)}getClassName(){return"ExponentialPace"}}QI_Lite.ExponentialPace=ExponentialPace;class PowerPace extends Pace{constructor(power=2,mode=Pace.MODE_IN){super(mode);this.power=power}_compute(currentDurationRatio){const y=Math.max(0,this.power);return Math.pow(currentDurationRatio,y)}getClassName(){return"PowerPace"}}QI_Lite.PowerPace=PowerPace;class QuadraticPace extends Pace{_compute(currentDurationRatio){return currentDurationRatio*currentDurationRatio}getClassName(){return"QuadraticPace"}}QI_Lite.QuadraticPace=QuadraticPace;class QuarticPace extends Pace{_compute(currentDurationRatio){return currentDurationRatio*currentDurationRatio*currentDurationRatio*currentDurationRatio}getClassName(){return"QuarticPace"}}QI_Lite.QuarticPace=QuarticPace;class QuinticPace extends Pace{_compute(currentDurationRatio){return currentDurationRatio*currentDurationRatio*currentDurationRatio*currentDurationRatio*currentDurationRatio}getClassName(){return"QuinticPace"}}QI_Lite.QuinticPace=QuinticPace;class SinePace extends Pace{_compute(currentDurationRatio){return 1-Math.sin(1.5707963267948966*(1-currentDurationRatio))}getClassName(){return"SinePace"}}QI_Lite.SinePace=SinePace;class BezierCurvePace extends Pace{constructor(x1=0,y1=0,x2=1,y2=1,mode=Pace.MODE_IN){super(mode);this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2}_compute(currentDurationRatio){return BABYLON.BezierCurve.Interpolate(currentDurationRatio,this.x1,this.y1,this.x2,this.y2)}getClassName(){return"BezierCurvePace"}}QI_Lite.BezierCurvePace=BezierCurvePace;class SteppedPace extends Pace{constructor(completionRatios,durationRatios){super(Pace.MODE_IN);this.completionRatios=completionRatios;this.durationRatios=durationRatios;if(QI_Lite.Assert){if(!(this.completionRatios instanceof Array)||!(this.durationRatios instanceof Array))BABYLON.Tools.Error("QI_Lite.SteppedPace: ratios not arrays");if(this.completionRatios.length!==this.durationRatios.length)BABYLON.Tools.Error("QI_Lite.SteppedPace: ratio arrays not of equal length");this.steps=this.completionRatios.length;if(this.steps===0)BABYLON.Tools.Error("QI_Lite.SteppedPace: ratio arrays cannot be empty");let cRatio,dRatio,prevD=-1;for(let i=0;i<this.steps;i++){cRatio=this.completionRatios[i];dRatio=this.durationRatios[i];if(cRatio<=0||dRatio<=0)BABYLON.Tools.Error("QI_Lite.SteppedPace: ratios must be > 0");if(cRatio>1||dRatio>1)BABYLON.Tools.Error("QI_Lite.SteppedPace: ratios must be <= 1");if(prevD>=dRatio)BABYLON.Tools.Error("QI_Lite.SteppedPace: durationRatios must be in increasing order");prevD=dRatio}if(cRatio!==1||dRatio!==1)BABYLON.Tools.Error("QI_Lite.SteppedPace: final ratios must be 1")}this.incremetalCompletionBetweenSteps=[this.completionRatios[0]];this.incremetalDurationBetweenSteps=[this.durationRatios[0]];for(let i=1;i<this.steps;i++){this.incremetalCompletionBetweenSteps.push(this.completionRatios[i]-this.completionRatios[i-1]);this.incremetalDurationBetweenSteps.push(this.durationRatios[i]-this.durationRatios[i-1])}Object.freeze(this)}getCompletionMilestone(currentDurationRatio){if(currentDurationRatio<=0)return 0;else if(currentDurationRatio>=1)return 1;let upperIdx=0;for(;upperIdx<this.steps;upperIdx++){if(currentDurationRatio<this.durationRatios[upperIdx])break}const baseCompletion=upperIdx>0?this.completionRatios[upperIdx-1]:0;const baseDuration=upperIdx>0?this.durationRatios[upperIdx-1]:0;const interStepRatio=(currentDurationRatio-baseDuration)/this.incremetalDurationBetweenSteps[upperIdx];return baseCompletion+interStepRatio*this.incremetalCompletionBetweenSteps[upperIdx]}getClassName(){return"SteppedPace"}toScript(){let comps="";let durs="";for(let i=0,len=this.completionRatios.length;i<len;i++){if(i>0){comps+=", ";durs+=", "}comps+=this.completionRatios[i];durs+=this.durationRatios[i]}return`new QI_Lite.SteppedPace([${comps}], [${durs}])`}}QI_Lite.SteppedPace=SteppedPace})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class MotionEvent{constructor(_milliDuration,movePOV,rotatePOV=null,scaling=null,options){this._milliDuration=_milliDuration;this.movePOV=movePOV;this.rotatePOV=rotatePOV;this.scaling=scaling;this._startTime=-1;this._currentDurationRatio=MotionEvent._BLOCKED;this._wasPriviledgedBlock=false;this.queueName=QI_Lite.PovProcessor.POV_QUEUE_NAME;this.muteSound=false;if(this._milliDuration<=0){if(QI_Lite.Assert)BABYLON.Tools.Error("MotionEvent: milliDuration must > 0");return}this._noOptions=!options;this.options=options||{millisBefore:0,absoluteMovement:false,absoluteRotation:false,pace:MotionEvent.LINEAR,sound:null,requireCompletionOf:null,noStepWiseMovement:false,debug:false,mirrorAxes:null,subposes:null,revertSubposes:false,privilegedEvent:false};this.options.millisBefore=this.options.millisBefore||0;this.options.absoluteMovement=this.options.absoluteMovement||false;this.options.absoluteRotation=this.options.absoluteRotation||false;this.options.pace=this.options.pace||MotionEvent.LINEAR;this.options.sound=this.options.sound||null;this.options.requireCompletionOf=this.options.requireCompletionOf||null;this.options.noStepWiseMovement=this.options.noStepWiseMovement||false;this.options.mirrorAxes=this.options.mirrorAxes||null;this.options.subposes=this.options.subposes||null;this.options.revertSubposes=this.options.revertSubposes||false;this.setProratedWallClocks(1,false)}toString(){let ret=`queue: ${this.queueName}, type: ${this.getClassName()}, duration: ${this._milliDuration}, wait: ${this.options.millisBefore}, pace: ${this.options.pace.getClassName()}`;if(this.movePOV)ret+=`, move: ${this.movePOV.toString()}`;if(this.rotatePOV)ret+=`, rotate: ${this.rotatePOV.toString()}`;if(this.scaling)ret+=`, scaling: ${this.scaling.toString()}`;if(this.options.sound)ret+=`, sound: "${this.options.sound.name}`;if(this.options.requireCompletionOf)ret+=", HAS mustComplete event";if(this.options.absoluteMovement)ret+=", absoluteMovement";if(this.options.absoluteRotation)ret+=", absoluteRotation: ";if(this.options.noStepWiseMovement)ret+=", noStepWiseMovement: ";return ret}toScript(){return this._toScriptImpl(true,true,true,true)}_toScriptImpl(needMillis,needMove,needRotate,needScaling){let ret=`new QI_Lite.${this.getClassName()}(${this._toScriptCustomArgs()}`;let first=this._toScriptCustomArgs()==="";if(needMillis){if(!first)ret+=", ";else first=false;ret+=this._milliDuration}if(needMove){if(!first)ret+=", ";else first=false;if(this.movePOV)ret+=`new QI_Lite.V(${this.movePOV.x}, ${this.movePOV.y}, ${this.movePOV.z})`;else ret+="null"}if(needRotate){if(!first)ret+=", ";else first=false;if(this.rotatePOV)ret+=`new QI_Lite.V(${this.rotatePOV.x}, ${this.rotatePOV.y}, ${this.rotatePOV.z})`;else ret+="null"}if(needScaling){if(!first)ret+=", ";else first=false;if(this.scaling)ret+=`new QI_Lite.V(${this.scaling.x}, ${this.scaling.y}, ${this.scaling.z})`;else ret+="null"}if(!this._noOptions)ret+=", "+this._toScriptOptions();return ret+")"}_toScriptCustomArgs(){return""}_toScriptOptions(){if(this._noOptions)return null;if(this.options.requireCompletionOf)throw"QI_Lite.MotionEvent: requireCompletionOf cannot be assigned for toScript";let ret="";let first=true;if(this.options.millisBefore!==0){if(!first)ret+=", ";else first=false;ret+=`millisBefore: ${this.options.millisBefore}`}if(this.options.absoluteMovement){if(!first)ret+=", ";else first=false;ret+="absoluteMovement : true"}if(this.options.absoluteRotation){if(!first)ret+=", ";else first=false;ret+="absoluteRotation : true"}if(this.options.pace!=MotionEvent.LINEAR){if(!first)ret+=", ";else first=false;ret+=`pace : "${this.options.pace.toScript()}`}if(this.options.sound){if(!first)ret+=", ";else first=false;ret+=`sound : ${this.options.sound.name}`}if(this.options.noStepWiseMovement){if(!first)ret+=", ";else first=false;ret+="noStepWiseMovement : true"}if(this.options.mirrorAxes){if(!first)ret+=", ";else first=false;ret+=`mirrorAxes : "${this.options.mirrorAxes}"`}if(this.options.subposes){if(!first)ret+=", ";else first=false;ret+='subposes : "[';for(let i=0,len=this.options.subposes.length;i<len;i++){if(i>0)ret+=", ";ret+=`"${this.options.subposes[i]}"`}ret+="]"}if(this.options.revertSubposes){if(!first)ret+=", ";else first=false;ret+="revertSubposes : true"}if(this.options.privilegedEvent){if(!first)ret+=", ";else first=false;ret+="privilegedEvent : true"}return ret.length>0?"{"+ret+"}":null}getClassName(){return"MotionEvent"}activate(lateStartMilli=0){this._startTime=this._now;this._firstFrameAmtComplete=QI_Lite.TimelineControl.frameAdvanceAmt;if(lateStartMilli>0){lateStartMilli/=5;this._startTime-=lateStartMilli<this._milliDuration/10?lateStartMilli:this._milliDuration/10}if(this.options.requireCompletionOf||this.options.sound&&!this.muteSound)this._currentDurationRatio=MotionEvent._BLOCKED;else if(this._proratedMillisBefore>0)this._currentDurationRatio=MotionEvent._WAITING;else this._currentDurationRatio=MotionEvent._READY;if(this.options.debug)BABYLON.Tools.Log(`\nActivated with initial ratio of ${this._currentDurationRatio}`)}getCompletionMilestone(){if(this._currentDurationRatio===MotionEvent._COMPLETE){return MotionEvent._COMPLETE}if(QI_Lite.TimelineControl.inPrivledgedMode&&!this.options.privilegedEvent){this._wasPriviledgedBlock=true;if(this.options.debug)BABYLON.Tools.Log(`priviledged blocked`);return MotionEvent._BLOCKED}else if(this._wasPriviledgedBlock){this._wasPriviledgedBlock=false;this._startTime=this._millisSoFar?this._now-this._millisSoFar:this._now;if(this.options.debug)BABYLON.Tools.Log(`privledged restart @ ratio: ${this._currentDurationRatio}`)}if(this._currentDurationRatio===MotionEvent._BLOCKED){if(this.isSoundReady()&&this.isPriorComplete()){this._startTime=this._now;this._currentDurationRatio=MotionEvent._WAITING}else{if(this.options.debug)BABYLON.Tools.Log(`Blocked`);return MotionEvent._BLOCKED}}this._currentDurationRatio=MotionEvent._WAITING;this._millisSoFar=this._now-this._startTime;if(this._currentDurationRatio===MotionEvent._WAITING){const overandAbove=this._millisSoFar-this._proratedMillisBefore;if(overandAbove>=0){this._startTime=this._now-overandAbove;this._millisSoFar=overandAbove;if(this.options.sound&&!this.muteSound){this.options.sound.play()}}else{if(this.options.debug)BABYLON.Tools.Log(`Waiting for `);return MotionEvent._WAITING}}this._currentDurationRatio=(this._millisSoFar+this._firstFrameAmtComplete)/this._proratedMilliDuration;if(this._currentDurationRatio>MotionEvent._COMPLETE)this._currentDurationRatio=MotionEvent._COMPLETE;if(this.options.debug)BABYLON.Tools.Log(`ratio: ${this._currentDurationRatio}, milli: ${this._millisSoFar}, frame-id: ${QI_Lite.TimelineControl.FrameID}, over: ${this._millisSoFar+this._firstFrameAmtComplete-this._proratedMilliDuration}`);return this.pace.getCompletionMilestone(this._currentDurationRatio)}isSoundReady(){return!this.options.sound||this.muteSound||this.options.sound.isReady()}isPriorComplete(){return!this.options.requireCompletionOf||this.options.requireCompletionOf.isComplete()}resumePlay(){if(this._currentDurationRatio===MotionEvent._COMPLETE||this._currentDurationRatio===MotionEvent._BLOCKED)return;this._startTime=this._now-this._millisSoFar;if(this.options.sound&&!this.muteSound&&this.options.sound.isPaused)this.options.sound.play()}pause(){if(this.options.sound)this.options.sound.pause()}isBlocked(){return this._currentDurationRatio<=MotionEvent._BLOCKED}isWaiting(){return this._currentDurationRatio===MotionEvent._WAITING}isComplete(){return this._currentDurationRatio===MotionEvent._COMPLETE}isExecuting(){return this._currentDurationRatio>MotionEvent._READY&&this._currentDurationRatio<MotionEvent._COMPLETE}get milliDuration(){return this._milliDuration}get millisBefore(){return this.options.millisBefore}get pace(){return this.options.pace}get _now(){return this.options.privilegedEvent?QI_Lite.TimelineControl.PrivilegedNow:QI_Lite.TimelineControl.Now}setProratedWallClocks(factor,isRepeat){this._proratedMilliDuration=this._milliDuration*factor;this._proratedMillisBefore=this.millisBefore>0||!isRepeat?Math.abs(this.millisBefore)*factor:0}static get BLOCKED(){return MotionEvent._BLOCKED}static get WAITING(){return MotionEvent._WAITING}static get READY(){return MotionEvent._READY}static get COMPLETE(){return MotionEvent._COMPLETE}}MotionEvent.LINEAR=new QI_Lite.SteppedPace([1],[1]);MotionEvent.SINE_INOUT_PACE=new QI_Lite.SinePace(QI_Lite.Pace.MODE_INOUT);MotionEvent._BLOCKED=-20;MotionEvent._WAITING=-10;MotionEvent._READY=0;MotionEvent._COMPLETE=1;QI_Lite.MotionEvent=MotionEvent;class Stall extends MotionEvent{constructor(milliDuration,queueName=QI_Lite.PovProcessor.POV_QUEUE_NAME,sound,afterEvt){super(milliDuration,null,null,null,{sound:sound,requireCompletionOf:afterEvt});this.queueName=queueName}toScript(){let ret=`new QI_Lite.Stall(${this.milliDuration}`;if(this.queueName!==QI_Lite.PovProcessor.POV_QUEUE_NAME)ret+=`, "${this.queueName}"`;if(this.options.sound)ret+=`, ${this.options.sound.name}`;return ret+")"}getClassName(){return"Stall"}}QI_Lite.Stall=Stall})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class SeriesAction extends BABYLON.Action{constructor(triggerOptions,_target,_eSeries,_clearQueue,_stopCurrentSeries,condition){super(triggerOptions,condition);this._target=_target;this._eSeries=_eSeries;this._clearQueue=_clearQueue;this._stopCurrentSeries=_stopCurrentSeries}execute(evt){this._target.queueEventSeries(this._eSeries,this._clearQueue,this._stopCurrentSeries)}}QI_Lite.SeriesAction=SeriesAction;class ParticipatingGroup{constructor(groupName){this.groupName=groupName;this._indexInRun=-99;this._highestIndexInRun=-1}isReady(){return this._indexInRun===-1}runComplete(){return this._indexInRun>this._highestIndexInRun}activate(){this._indexInRun=-1}}class EventSeries{constructor(_events,_nRepeats=1,_initialWallclockProrating=1,_groupForFuncActions=QI_Lite.PovProcessor.POV_QUEUE_NAME,_debug=false){this._events=_events;this._nRepeats=_nRepeats;this._initialWallclockProrating=_initialWallclockProrating;this._groupForFuncActions=_groupForFuncActions;this._debug=_debug;this._groups=new Array;this._nGroups=0;this._nEvents=this._events.length;this._prorating=this._initialWallclockProrating!==1&&this._nRepeats!=-1;if(QI_Lite.Assert&&this._nRepeats===1&&this._prorating)BABYLON.Tools.Warn("EventSeries: clock prorating ignored when # of repeats is 1");for(let i=0;i<this._nEvents;i++){const evt=this._events[i];if(QI_Lite.Assert){let passed=false;if(evt instanceof QI_Lite.MotionEvent)passed=true;else if(evt instanceof BABYLON.Action)passed=true;else if(typeof evt==="function")passed=true;if(!passed){BABYLON.Tools.Error(`EventSeries:  events must either be a MotionEvent, Action, or function.  Problem idx: ${i}`);return}}const groupName=this._events[i]instanceof QI_Lite.MotionEvent?this._events[i].queueName:this._groupForFuncActions;this._addGroupAsRequired(groupName,i);if(this._events[i]instanceof BABYLON.Action)this._events[i]._prepare()}}toString(){let ret=`number of events: ${this._nEvents}, repeats: ${this._nRepeats}, # groups: ${this._nGroups}`;for(let i=0;i<this._nEvents;i++){if(this._events[i]instanceof QI_Lite.MotionEvent)ret+=`\n\t\t${i}- ${this._events[i].toString()}`;else ret+=`\n\t\t${i}- group: ${this._groupForFuncActions}`}return ret}_addGroupAsRequired(groupName,eventIdx){let pGroup=null;for(const grp of this._groups){if(grp.groupName===groupName){pGroup=grp;break}}if(pGroup===null){pGroup=new ParticipatingGroup(groupName);this._groups.push(pGroup);this._nGroups++}pGroup._highestIndexInRun=eventIdx}hasMultipleParticipants(){return this._nGroups>1}isGroupParticipating(groupName){for(const grp of this._groups){if(grp.groupName===groupName)return true}return false}activate(groupName,enableDebug){this._indexInRun=-1;this._repeatCounter=0;this._proRatingThisRepeat=this._nRepeats>1?this._initialWallclockProrating:1;this._appyProrating();this._everybodyReady=true;for(const grp of this._groups){if(grp.groupName===groupName)grp.activate();else this._everybodyReady=this._everybodyReady&&grp.isReady()}if(enableDebug)this._debug=true;if(this._debug)BABYLON.Tools.Log(`EventSeries: series activated by ${groupName}, _everybodyReady: ${this._everybodyReady}`)}hasMoreEvents(){return this._repeatCounter<this._nRepeats||this._nRepeats===-1}nextEvent(groupName){if(!this._everybodyReady){if(this._debug)BABYLON.Tools.Log("EventSeries: nextEvent, not everybody or partner ready");return null}if(this.hasMultipleParticipants()){return this._nextGroupEvent(groupName)}if(++this._indexInRun===this._nEvents){if(++this._repeatCounter<this._nRepeats||this._nRepeats===-1){this._indexInRun=0;if(this._prorating){this._proRatingThisRepeat=this._initialWallclockProrating+(1-this._initialWallclockProrating)*((this._repeatCounter+1)/this._nRepeats)}this._appyProrating()}else{return null}}if(this._debug)console.log(`EventSeries: nextEvent ${this._indexInRun} in series returned`,this._events[this._indexInRun]);return this._events[this._indexInRun]}_appyProrating(){for(const evt of this._events){if(evt instanceof QI_Lite.MotionEvent){evt.setProratedWallClocks(this._proRatingThisRepeat,this._repeatCounter>0)}}}_nextGroupEvent(groupName){let pGroup;let allGroupsRunComplete=true;for(const grp of this._groups){allGroupsRunComplete=allGroupsRunComplete&&grp.runComplete();if(grp.groupName===groupName){pGroup=grp}}if(allGroupsRunComplete){if(++this._repeatCounter<this._nRepeats||this._nRepeats===-1){for(const grp of this._groups){grp.activate()}if(this._initialWallclockProrating!==1){this._proRatingThisRepeat=this._initialWallclockProrating+(1-this._initialWallclockProrating)*((this._repeatCounter+1)/this._nRepeats)}if(this._debug)BABYLON.Tools.Log(`EventSeries: set for repeat # ${this._repeatCounter}`)}else{if(this._debug)console.log("EventSeries: Series complete");this._everybodyReady=false}}if(!pGroup.runComplete()){if(pGroup._indexInRun===pGroup._highestIndexInRun){pGroup._indexInRun++;if(this._debug)BABYLON.Tools.Log(`EventSeries: group ${pGroup.groupName} has completed series.`);return null}for(let i=pGroup._indexInRun+1;i<this._nEvents;i++){const groupName=this._events[i]instanceof QI_Lite.MotionEvent?this._events[i].queueName:this._groupForFuncActions;if(pGroup.groupName===groupName){pGroup._indexInRun=i;if(this._events[i]instanceof QI_Lite.MotionEvent){this._events[i].setProratedWallClocks(this._proRatingThisRepeat,this._repeatCounter>0)}if(this._debug)BABYLON.Tools.Log(`EventSeries: ${i} in series returned: ${groupName}, allGroupsRunComplete ${allGroupsRunComplete}, everybodyReady ${this._everybodyReady}`);return this._events[i]}}}else return null}}QI_Lite.EventSeries=EventSeries})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class PovProcessor{constructor(node,_skipRegistration=false){this._skipRegistration=_skipRegistration;this._queue=new Array;this._currentSeries=null;this._currentStepInSeries=null;this._endOfLastFrameTs=-1;this._doingRotation=false;this._rotationStart=BABYLON.Vector3.Zero();this._rotationEnd=BABYLON.Vector3.Zero();this._rotationMatrix=new BABYLON.Matrix;this._doingMovePOV=false;this._positionStartVec=BABYLON.Vector3.Zero();this._positionEndVec=BABYLON.Vector3.Zero();this._doingScaling=false;this._scalingStart=BABYLON.Vector3.Zero();this._scalingEnd=BABYLON.Vector3.Zero();this._name=PovProcessor.POV_QUEUE_NAME;this._calcRef=BABYLON.Vector3.Zero();this._lastResumeTime=0;this._instancePaused=false;this._subClassImplemented=node instanceof BABYLON.Scene;this._scene=this._subClassImplemented?node:node.getScene();QI_Lite.TimelineControl.initialize(this._scene);if(!this._subClassImplemented){this._node=node;this._isMesh=!this._subClassImplemented&&this._node instanceof BABYLON.AbstractMesh;this._isLight=!this._subClassImplemented&&this._node instanceof BABYLON.Light;this._isCamera=!this._subClassImplemented&&this._node instanceof BABYLON.Camera;this._isQIMesh=this._isMesh&&this._node instanceof QI_Lite.Mesh;if(this._isCamera){if(!(this._node instanceof BABYLON.TargetCamera))throw new Error("PovProcessor: Only TargetCamera subclasses can use Queued Interpolation");if(this._node.lockedTarget)throw new Error("PovProcessor: Camera with a lockedTarget cannot use Queued Interpolation");this._rotationProperty="rotation"}else if(this._isLight){if(!this._node["position"]||!this._node["direction"])throw new Error("PovProcessor: Only SpotLight & DirectionalLight can use Queued Interpolation");this._rotationProperty="direction"}else if(this._isMesh){this._rotationProperty="rotation"}}if(!_skipRegistration){this._incrementallyMove=this._incrementallyMove.bind(this);this._scene.registerBeforeRender(this._incrementallyMove)}}get name(){return this._name}dispose(){if(!this._skipRegistration){this._scene.unregisterBeforeRender(this._incrementallyMove)}}_scheduleEvent(){if(this._instancePaused||QI_Lite.TimelineControl.isSystemPaused){if(this._currentStepInSeries)this._currentStepInSeries.pause();return false}if(this._lastResumeTime<QI_Lite.TimelineControl.SystemResumeTime){this._lastResumeTime=QI_Lite.TimelineControl.SystemResumeTime;this.resumeInstancePlay()}if(this._currentSeries===null||!this._currentSeries.hasMoreEvents()){if(!this._nextEventSeries())return false}while(this._currentSeries!==null&&(this._currentStepInSeries===null||this._currentStepInSeries.isComplete())){if(QI_Lite.TimelineControl.inPrivledgedMode)return false;const next=this._currentSeries.nextEvent(this._name);if(next===null)return false;if(next instanceof BABYLON.Action&&this._isMesh){next.execute(BABYLON.ActionEvent.CreateNew(this._node))}else if(typeof next==="function"){next.call()}else{this._nextEvent(next);this._ratioLastFrame=-1e3}}this._ratioComplete=this._currentStepInSeries.getCompletionMilestone();if(this._ratioComplete<0)return false;if(this._ratioLastFrame===this._ratioComplete){return false}this._ratioLastFrame=this._ratioComplete;if(this._currentStepInSeries instanceof QI_Lite.NonMotionEvent){this._currentStepInSeries._incrementallyUpdate(this._ratioComplete);return false}return true}_incrementallyMove(){const haveEvent=this._scheduleEvent();if(!haveEvent)return false;try{this._runOfStep++;if(this._doingRotation){BABYLON.Vector3.LerpToRef(this._rotationStart,this._rotationEnd,this._ratioComplete,this._node[this._rotationProperty])}if(this._doingMovePOV){if(this._doingRotation&&!this._currentStepInSeries.options.noStepWiseMovement&&!this._currentStepInSeries.options.absoluteMovement){const amtRight=this._fullAmtRight*this._ratioComplete-this._amtRightSoFar;const amtUp=this._fullAmtUp*this._ratioComplete-this._amtUpSoFar;const amtForward=this._fullAmtForward*this._ratioComplete-this._amtForwardSoFar;this.movePOV(amtRight,amtUp,amtForward);this._amtRightSoFar+=amtRight;this._amtUpSoFar+=amtUp;this._amtForwardSoFar+=amtForward}else{BABYLON.Vector3.LerpToRef(this._positionStartVec,this._positionEndVec,this._ratioComplete,this._node["position"])}if(this._activeLockedCamera!==null)this._activeLockedCamera.getViewMatrix()}if(this._doingScaling){BABYLON.Vector3.LerpToRef(this._scalingStart,this._scalingEnd,this._ratioComplete,this._node["scaling"])}if((this._doingRotation||this._doingMovePOV||this._doingScaling)&&this._isMesh&&this._node.isWorldMatrixFrozen){this._node.freezeWorldMatrix()}if(this._isCamera)this._node._getViewMatrix();return true}finally{this._endOfLastFrameTs=QI_Lite.TimelineControl.Now}}queueEventSeries(eSeriesOrArray,clearQueue,stopCurrentSeries){let eSeries;if(eSeriesOrArray instanceof QI_Lite.EventSeries)eSeries=eSeriesOrArray;else eSeries=new QI_Lite.EventSeries(eSeriesOrArray);if(clearQueue)this.clearQueue(stopCurrentSeries);this._queue.push(eSeries)}queueFunction(func,afterEvt,additionalMillis=0){const stall=new QI_Lite.Stall(1+additionalMillis,this._name,null,afterEvt);const events=[stall,func];this.queueEventSeries(events);return stall}queueStall(milliDuration,sound,afterEvt){const stall=new QI_Lite.Stall(milliDuration,this._name,sound,afterEvt);this.queueSingleEvent(stall);return stall}insertSeriesInFront(eSeriesOrArray){let eSeries;if(eSeriesOrArray instanceof QI_Lite.EventSeries)eSeries=eSeriesOrArray;else eSeries=new QI_Lite.EventSeries(eSeriesOrArray);this._queue.splice(0,0,eSeries)}queueSingleEvent(event,nRepeats=1){this.queueEventSeries(new QI_Lite.EventSeries([event],nRepeats))}clearQueue(stopCurrentSeries){this._queue=new Array;if(stopCurrentSeries)this._currentSeries=null}stopCurrent(step,series){if(step)this._currentStepInSeries=null;if(series)this._currentSeries=null}_nextEventSeries(){const ret=this._queue.length>0&&(!this._node||this._node.isEnabled()&&this._node._currentRenderId!==-1);if(ret){this._currentSeries=this._queue.shift();this._currentSeries.activate(this._name,this._isQIMesh&&this._node.debug)}else this._currentSeries=null;this._currentStepInSeries=null;return ret}isActive(){return this._currentSeries!==null||this._queue.length>0}getQueueState(){let ret=`${this._name} queue state:  number series queued: ${this._queue.length}`;if(this._isQIMesh){ret+=`, paused : ${this._node.isPaused()}`;ret+=`, mesh visible : ${this._node.isVisible}`}for(let i=0,len=this._queue.length;i<len;i++){ret+=`\n\tSeries ${i}- ${this._queue[i].toString()}`}if(this._currentSeries){ret+=`\n\n\t Current processing: \n${this._currentSeries.toString()}`}return ret}_nextEvent(event){const lateStart=QI_Lite.TimelineControl.isRealtime?QI_Lite.TimelineControl.Now-this._endOfLastFrameTs:0;event.activate(lateStart-this._endOfLastFrameTs<PovProcessor.MAX_MILLIS_FOR_EVENT_LATE_START&&!this._currentSeries.hasMultipleParticipants()?lateStart:0);this._currentStepInSeries=event;if(event instanceof QI_Lite.NonMotionEvent){event.initialize(lateStart)}this._doingRotation=event.rotatePOV!==null;if(this._doingRotation){this._rotationStart.copyFrom(this._node[this._rotationProperty]);this._rotationEnd=event.options.absoluteRotation?event.rotatePOV.clone():this._rotationStart.add(this.calcRotatePOV(event.rotatePOV.x,event.rotatePOV.y,event.rotatePOV.z))}this._doingMovePOV=event.movePOV!==null;if(this._doingMovePOV){let movePOV=event.movePOV;this._positionStartVec.copyFrom(this._node["position"]);this._fullAmtRight=movePOV.x;this._amtRightSoFar=0;this._fullAmtUp=movePOV.y;this._amtUpSoFar=0;this._fullAmtForward=movePOV.z;this._amtForwardSoFar=0;if(!this._doingRotation||event.options.noStepWiseMovement||event.options.absoluteMovement){if(event.options.absoluteMovement)this._positionEndVec.copyFrom(event.movePOV);else this._positionStartVec.addToRef(this.calcMovePOV(this._fullAmtRight,this._fullAmtUp,this._fullAmtForward),this._positionEndVec)}}this._doingScaling=event.scaling!==null;if(this._doingScaling){this._scalingStart.copyFrom(this._node["scaling"]);this._scalingEnd=event.scaling.clone()}this._activeLockedCamera=null;if((this._doingRotation||this._doingMovePOV)&&this._isMesh){const activeCamera=this._node.getScene().activeCamera;const target=activeCamera.lockedTarget||activeCamera.target;if(target&&target===this._node)this._activeLockedCamera=activeCamera}this._runOfStep=0}movePOV(amountRight,amountUp,amountForward){this._node["position"].addInPlace(this.calcMovePOV(amountRight,amountUp,amountForward,this._calcRef))}calcMovePOV(amountRight,amountUp,amountForward,ref){const rot=this._node[this._rotationProperty];BABYLON.Matrix.RotationYawPitchRollToRef(rot.y,rot.x,rot.z,this._rotationMatrix);const translationDelta=ref?ref:BABYLON.Vector3.Zero();const defForwardMult=this._isMesh?this._node.definedFacingForward?-1:1:1;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(amountRight*defForwardMult,amountUp,amountForward*defForwardMult,this._rotationMatrix,translationDelta);return translationDelta}rotatePOV(flipBack,twirlClockwise,tiltRight){const amt=this.calcRotatePOV(flipBack,twirlClockwise,tiltRight);this._node[this._rotationProperty].addInPlace(amt)}calcRotatePOV(flipBack,twirlClockwise,tiltRight){const defForwardMult=this._isMesh?this._node.definedFacingForward?1:-1:1;return new BABYLON.Vector3(flipBack*defForwardMult,twirlClockwise,tiltRight*defForwardMult)}isInstancePaused(){return this._instancePaused}pauseInstance(){this._instancePaused=true}resumeInstancePlay(){this._lastResumeTime=QI_Lite.TimelineControl.Now;this._instancePaused=false;if(this._currentStepInSeries!==null)this._currentStepInSeries.resumePlay()}static get Version(){return"1.0"}static formatQuat(d){return`{X: ${d.x.toFixed(4)}, Y: ${d.y.toFixed(4)}, Z: ${d.z.toFixed(4)}, W: ${d.w.toFixed(4)}}`}}PovProcessor.POV_QUEUE_NAME="POV_PROCESSOR";PovProcessor.MAX_MILLIS_FOR_EVENT_LATE_START=50;QI_Lite.PovProcessor=PovProcessor})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class XRSubCamera extends BABYLON.TargetCamera{constructor(stockRigCam,camFlyer,debug){super(stockRigCam.name,stockRigCam.position,stockRigCam.getScene());this.camFlyer=camFlyer;this.debug=debug;this.minZ=stockRigCam.minZ;this.rotationQuaternion=stockRigCam.rotationQuaternion;this.updateUpVectorFromRotation=stockRigCam.updateUpVectorFromRotation;this.isRigCamera=true;this.rigParent=stockRigCam.rigParent;this.freezeProjectionMatrix()}_checkInputs(){this.position.addInPlace(this.camFlyer.addedPosition);super._checkInputs();if(this.debug&&!this.camFlyer.addedPosition.equalsToFloats(0,0,0)){console.log(`adjustment: ${this.camFlyer.addedPosition.toString()}`)}}}class XRCameraFlyer extends QI_Lite.PovProcessor{constructor(xrHelper,scene){super(scene);this._swapped=false;this.metersPerSec=50;this.metersPerSecLongDistance=150;this.shortDistCutOff=50;this.addedPosition=BABYLON.Vector3.Zero();this._moveAmt=BABYLON.Vector3.Zero();xrHelper.onInitialXRPoseSetObservable.add(xrCamera=>{this.actualXRWebCamera=xrCamera})}flyTo(loc){loc.subtractToRef(this.actualXRWebCamera.position,this._moveAmt);const distance=Math.sqrt(this._moveAmt.x**2+this._moveAmt.y**2+this._moveAmt.x**2);const rate=distance<this.shortDistCutOff?this.metersPerSec:this.metersPerSecLongDistance;const duration=distance/rate*1e3;const events=[new QI_Lite.MotionEvent(duration,loc,null,null,{pace:this._pace}),()=>{if(this.teleporter){this.teleporter.telePortAnimComplete();this.resetPositions()}}];this.queueEventSeries(events)}resetPositions(){this.clearQueue(true);this.addedPosition.copyFromFloats(0,0,0)}_getPace(){if(!this._pace){const completionRatios=[.05,.98,1];const durationRatios=[.1,.9,1];this._pace=new QI_Lite.SteppedPace(completionRatios,durationRatios)}return this._pace}_incrementallyMove(){if(!this._swapped&&this.actualXRWebCamera){if(this.actualXRWebCamera.rigCameras.length!==2){return false}for(let i=0;i<this.actualXRWebCamera.rigCameras.length;i++){const old=this.actualXRWebCamera.rigCameras[i];this.actualXRWebCamera.rigCameras[i]=new XRSubCamera(old,this,i===9);old.dispose()}this._swapped=true}if(!this._scheduleEvent())return false;BABYLON.Vector3.LerpToRef(this._positionStartVec,this._positionEndVec,this._ratioComplete,this.addedPosition);return true}_nextEvent(event){const lateStart=QI_Lite.TimelineControl.isRealtime?QI_Lite.TimelineControl.Now-this._endOfLastFrameTs:0;event.activate(lateStart-this._endOfLastFrameTs<QI_Lite.PovProcessor.MAX_MILLIS_FOR_EVENT_LATE_START&&!this._currentSeries.hasMultipleParticipants()?lateStart:0);this._currentStepInSeries=event;this._positionStartVec.copyFromFloats(0,0,0);this._positionEndVec.copyFrom(event.movePOV);this._positionEndVec.subtractInPlace(this.actualXRWebCamera.position)}}QI_Lite.XRCameraFlyer=XRCameraFlyer})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class FlyingTeleporter extends BABYLON.WebXRMotionControllerTeleportation{constructor(xrSessionManager,options){super(xrSessionManager,options);this._originalPosition=BABYLON.Vector3.Zero();this._finalDestination=BABYLON.Vector3.Zero();FlyingTeleporter.ding=new BABYLON.Sound("ding","./audio/ding.wav",xrSessionManager.scene)}initialize(defaultExperience){this.camFlyer=new QI_Lite.XRCameraFlyer(defaultExperience.baseExperience,this._xrSessionManager.scene);this.camFlyer.teleporter=this}_teleportForward(controllerId){this._originalPosition.copyFrom(this.camFlyer.actualXRWebCamera.position);this._finalDestination.copyFrom(this.teleportationTargetMesh.position);this._finalDestination.y+=this.camFlyer.actualXRWebCamera.realWorldHeight;super._teleportForward(controllerId);if(this._originalPosition.equals(this.camFlyer.actualXRWebCamera.position)){return}this.camFlyer.actualXRWebCamera.position.copyFrom(this._originalPosition);this.camFlyer.flyTo(this._finalDestination)}telePortAnimComplete(){this.camFlyer.actualXRWebCamera.position.copyFrom(this._finalDestination);FlyingTeleporter.ding.setVolume(.1);FlyingTeleporter.ding.play()}report(){let ret=`Main cam: ${this.camFlyer.actualXRWebCamera.position.toString()}, `;ret+=`Target Mesh: ${this.teleportationTargetMesh.position.toString()}`;return ret}}FlyingTeleporter.Name="QI_Lite.FlyingTeleporter";FlyingTeleporter.Version=1;QI_Lite.FlyingTeleporter=FlyingTeleporter;BABYLON.WebXRFeaturesManager.AddWebXRFeature(FlyingTeleporter.Name,(xrSessionManager,options)=>{return()=>new FlyingTeleporter(xrSessionManager,options)},FlyingTeleporter.Version,false)})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class InstancedMesh extends BABYLON.InstancedMesh{constructor(name,source){super(name,source);this._freezeExemption=false;this._instancePaused=true;this._povProcessor=new QI_Lite.PovProcessor(this,false)}set freezeExemption(value){this._freezeExemption=value;if(!this._freezeExemption)this.freezeWorldMatrix();else this.unfreezeWorldMatrix()}get freezeExemption(){return this._freezeExemption}freezeWorldMatrix(){const ret=super.freezeWorldMatrix();for(const kid of this.getDescendants()){if((kid instanceof BABYLON.AbstractMesh||kid instanceof BABYLON.TransformNode)&&kid.isWorldMatrixFrozen){kid.freezeWorldMatrix()}}return ret}unfreezeWorldMatrix(){const ret=super.unfreezeWorldMatrix();for(const kid of this.getDescendants()){if(kid instanceof BABYLON.AbstractMesh||kid instanceof BABYLON.TransformNode){kid.unfreezeWorldMatrix()}}return ret}beforeRender(){this._povProcessor._incrementallyMove()}clearAllQueues(stopCurrentSeries){if(this._povProcessor){this._povProcessor.clearQueue(stopCurrentSeries)}}queueSingleEvent(event){this.queueEventSeries(new QI_Lite.EventSeries([event]))}queueEventSeries(eSeriesOrArray,clearQueue,stopCurrentSeries,insertSeriesInFront){let eSeries;if(eSeriesOrArray instanceof QI_Lite.EventSeries)eSeries=eSeriesOrArray;else eSeries=new QI_Lite.EventSeries(eSeriesOrArray);if(eSeries.isGroupParticipating(QI_Lite.PovProcessor.POV_QUEUE_NAME)){if(insertSeriesInFront){this._povProcessor.insertSeriesInFront(eSeries)}else{this._povProcessor.queueEventSeries(eSeries)}}}getAllQueueStates(){let ret=this._povProcessor.getQueueState();return ret}queueFunction(func,groupName=QI_Lite.PovProcessor.POV_QUEUE_NAME){const stall=new QI_Lite.Stall(1,groupName);const events=[func,stall];this.queueEventSeries(events);return stall}queuePOV(milliDuration,movePOV=null,rotatePOV=null,scaling=null,options){const event=new QI_Lite.MotionEvent(milliDuration,movePOV,rotatePOV,scaling,options);this.queueSingleEvent(event);return event}makeVisible(visible){this.isVisible=visible;if(visible)this.resumeInstancePlay();else this.pausePlay()}isPaused(){return this._instancePaused}pausePlay(){this._instancePaused=true;if(this._povProcessor){this._povProcessor.pauseInstance()}}resumeInstancePlay(){this._instancePaused=false;if(this._povProcessor){this._povProcessor.resumeInstancePlay()}}}QI_Lite.InstancedMesh=InstancedMesh})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class Mesh extends BABYLON.Mesh{constructor(name,scene,parent=null,source,doNotCloneChildren){super(name,scene,parent,source,doNotCloneChildren);this.debug=false;this._beforeRenderReqd=false;this._lastFrameID=-1;this._matrixFreezeExemption=false;this._instancePaused=true}set matrixFreezeExemption(value){this._matrixFreezeExemption=value;if(!this._matrixFreezeExemption)this.freezeWorldMatrix();else this.unfreezeWorldMatrix()}get matrixFreezeExemption(){return this._matrixFreezeExemption}freezeWorldMatrix(){const ret=super.freezeWorldMatrix();for(const kid of this.getDescendants()){if((kid instanceof BABYLON.AbstractMesh||kid instanceof BABYLON.TransformNode)&&kid.isWorldMatrixFrozen){kid.freezeWorldMatrix()}}return ret}unfreezeWorldMatrix(){const ret=super.unfreezeWorldMatrix();for(const kid of this.getDescendants()){if(kid instanceof BABYLON.AbstractMesh||kid instanceof BABYLON.TransformNode){kid.unfreezeWorldMatrix()}}return ret}_addBeforeRender(){if(!this._beforeRenderReqd){this.beforeRender=this.beforeRender.bind(this);this.getScene().registerBeforeRender(this.beforeRender);this._beforeRenderReqd=true}}beforeRender(){if(this._positions32F===null||this._normals32F===null||QI_Lite.TimelineControl.isSystemPaused||this._instancePaused)return;if(this._lastFrameID===QI_Lite.TimelineControl.FrameID)return;this._lastFrameID=QI_Lite.TimelineControl.FrameID;if(this._povProcessor){this._povProcessor._incrementallyMove()}for(const inst of this.instances){if(inst instanceof QI_Lite.InstancedMesh){inst.beforeRender()}}}setEnabled(value){super.setEnabled(value);if(value&&this.isPaused)this.resumeInstancePlay()}createInstance(name){return new QI_Lite.InstancedMesh(name,this)}setVerticesData(kind,data,updatable,stride){super.setVerticesData(kind,data,updatable||kind===BABYLON.VertexBuffer.PositionKind||kind===BABYLON.VertexBuffer.NormalKind,stride);if(kind===BABYLON.VertexBuffer.PositionKind){this._positions32F=this.setPositionsForCPUSkinning()}else if(kind===BABYLON.VertexBuffer.NormalKind){this._normals32F=this.setNormalsForCPUSkinning()}return this}dispose(doNotRecurse,disposeMaterialAndTextures=false){super.dispose(doNotRecurse,disposeMaterialAndTextures);if(this._beforeRenderReqd)this.getScene().unregisterBeforeRender(this.beforeRender)}clearAllQueues(stopCurrentSeries){if(this._povProcessor){this._povProcessor.clearQueue(stopCurrentSeries)}}queueSingleEvent(event){this.queueEventSeries(new QI_Lite.EventSeries([event]))}queueEventSeries(eSeriesOrArray,clearQueue,stopCurrentSeries,insertSeriesInFront){this._addBeforeRender();let eSeries;if(eSeriesOrArray instanceof QI_Lite.EventSeries)eSeries=eSeriesOrArray;else eSeries=new QI_Lite.EventSeries(eSeriesOrArray);if(eSeries.isGroupParticipating(QI_Lite.PovProcessor.POV_QUEUE_NAME)){if(!this._povProcessor){this._povProcessor=new QI_Lite.PovProcessor(this,true)}if(insertSeriesInFront){this._povProcessor.insertSeriesInFront(eSeries)}else{this._povProcessor.queueEventSeries(eSeries)}}}queueFunction(func,groupName=QI_Lite.PovProcessor.POV_QUEUE_NAME){const stall=new QI_Lite.Stall(1,groupName);const events=[func,stall];this.queueEventSeries(events);return stall}queuePOV(milliDuration,movePOV=null,rotatePOV=null,scaling=null,options){const event=new QI_Lite.MotionEvent(milliDuration,movePOV,rotatePOV,scaling,options);this.queueSingleEvent(event);return event}isReady(completeCheck=false,forceInstanceSupport=false){const stockAnswer=super.isReady(completeCheck,forceInstanceSupport);if(!stockAnswer)return false;if(!completeCheck)return stockAnswer;const children=this.getChildMeshes();for(const kid of children){if(!kid.isReady(completeCheck))return false}return true}makeVisible(visible){this.isVisible=visible;if(visible)this.resumeInstancePlay();else this.pausePlay();const children=this.getChildMeshes();for(const kid of children){if(kid instanceof Mesh){kid.makeVisible(visible)}else{kid.isVisible=visible}}}set visibilityAndKids(value){const children=this.getChildMeshes();for(const kid of children){if(kid instanceof BABYLON.Mesh){kid.visibility=value}}this.visibility=value}isPaused(){return this._instancePaused}pausePlay(){this._instancePaused=true;if(this._povProcessor){this._povProcessor.pauseInstance()}}resumeInstancePlay(){this._instancePaused=false;if(this._povProcessor){this._povProcessor.resumeInstancePlay()}}}QI_Lite.Mesh=Mesh})(QI_Lite||(QI_Lite={}));var QI_Lite;(function(QI_Lite){class NonMotionEvent extends QI_Lite.MotionEvent{constructor(){super(...arguments);this._paused=false}initialize(lateStartMilli=0,scene){this.activate(lateStartMilli);if(scene){QI_Lite.TimelineControl.initialize(scene);if(this.options.privilegedEvent)QI_Lite.TimelineControl.inPrivledgedMode=true;this._registeredFN=(()=>{this._beforeRender()});scene.registerBeforeRender(this._registeredFN);this._scene=scene}}toScript(){return"NonMotionEvents DO NOT Support toScript"}getClassName(){return"NonMotionEvent"}_beforeRender(){if(!this.options.privilegedEvent){if(QI_Lite.TimelineControl.isSystemPaused){if(!this._paused){this.pause();this._paused=true}return}else if(this._paused){this._paused=false;this.resumePlay()}}const ratioComplete=this.getCompletionMilestone();if(ratioComplete<0)return;this._incrementallyUpdate(ratioComplete);if(this.isComplete()){this._clear()}}_clear(){if(this._scene){this._paused=false;this._scene.unregisterBeforeRender(this._registeredFN);this._scene=null;if(this.options.privilegedEvent)QI_Lite.TimelineControl.inPrivledgedMode=false}if(this._alsoCleanFunc)this._alsoCleanFunc()}alsoClean(func){this._alsoCleanFunc=func}_incrementallyUpdate(ratioComplete){}}QI_Lite.NonMotionEvent=NonMotionEvent;class PropertyEvent extends NonMotionEvent{constructor(_object,_property,_targetValue,milliDuration,options){super(milliDuration,null,null,null,options);this._object=_object;this._property=_property;this._targetValue=_targetValue;if(typeof this._targetValue==="number"){this._datatype=PropertyEvent._NUMBER_TYPE}else if(this._targetValue instanceof BABYLON.Vector3){this._datatype=PropertyEvent._VEC3_TYPE}else throw"Datatype not supported"}getClassName(){return"PropertyEvent"}initialize(lateStartMilli=0,scene){switch(this._datatype){case PropertyEvent._NUMBER_TYPE:this._initialValue=this._object[this._property];break;case PropertyEvent._VEC3_TYPE:this._initialValue=this._object[this._property].clone();break}this._initialValue=this._object[this._property];super.initialize(lateStartMilli,scene)}_incrementallyUpdate(ratioComplete){if(ratioComplete<0)return;switch(this._datatype){case PropertyEvent._NUMBER_TYPE:this._object[this._property]=this._initialValue+(this._targetValue-this._initialValue)*ratioComplete;break;case PropertyEvent._VEC3_TYPE:this._object[this._property]=BABYLON.Vector3.Lerp(this._initialValue,this._targetValue,ratioComplete);break}}}PropertyEvent._NUMBER_TYPE=1;PropertyEvent._VEC3_TYPE=2;QI_Lite.PropertyEvent=PropertyEvent;class RecurringCallbackEvent extends NonMotionEvent{constructor(_callback,milliDuration,options){super(milliDuration,null,null,null,options);this._callback=_callback}getClassName(){return"RecurringCallbackEvent"}_incrementallyUpdate(ratioComplete){if(ratioComplete<0)return;this._callback(ratioComplete)}}QI_Lite.RecurringCallbackEvent=RecurringCallbackEvent})(QI_Lite||(QI_Lite={}));var TOB;(function(TOB){class ModuleRegistration{static RegDirectory(moduleNm,directory){if(!QI_Lite.TimelineControl.scene)throw"App malpractice, establish scene BEFORE registering Modules";if(!directory.endsWith("/"))directory+="/";ModuleRegistration.Directory[moduleNm]=directory;for(const mod of ModuleRegistration._getModules(moduleNm)){ModuleRegistration._CompleteReg(mod,directory)}}static RegMod(moduleNm,fileName,mod){const moduleWtFileNm=`${moduleNm}-${fileName}`;ModuleRegistration.Module[moduleWtFileNm]=mod;const directory=ModuleRegistration.Directory[moduleNm];if(directory)ModuleRegistration._CompleteReg(mod,directory)}static _CompleteReg(mod,resourcesRootDir){mod.defineMaterials(QI_Lite.TimelineControl.scene,resourcesRootDir)}static _getModules(moduleNm){const ret=new Array;for(const moduleWtFileNm of Object.keys(ModuleRegistration.Module)){if(moduleWtFileNm.startsWith(moduleNm))ret.push(ModuleRegistration.Module[moduleWtFileNm])}return ret}}ModuleRegistration.Module={};ModuleRegistration.Directory={};TOB.ModuleRegistration=ModuleRegistration;TOB.M=BABYLON.Matrix.FromValues;function CONTIG(array,offset,begin,end){for(let i=0,len=1+end-begin;i<len;i++){array[offset+i]=begin+i}}TOB.CONTIG=CONTIG;function REPEAT(array,offset,nRepeats,val){for(let i=0;i<nRepeats;i++){array[offset+i]=val}}TOB.REPEAT=REPEAT;function UNPACK(compressed){const len=compressed.length*4;let ret=new Float32Array(len);for(let i=0,j=0;i<len;i+=4,j++){ret[i]=compressed[j]&255;ret[i+1]=(compressed[j]&65280)>>8;ret[i+2]=(compressed[j]&16711680)>>16;ret[i+3]=compressed[j]>>24}return ret}TOB.UNPACK=UNPACK;function FreshenShadowRenderLists(scene){const renderList=Array();for(const mesh of scene.meshes){if(mesh["castShadows"])renderList.push(mesh)}for(const light of scene.lights){if(light._shadowGenerator)light._shadowGenerator.getShadowMap().renderList=renderList}}TOB.FreshenShadowRenderLists=FreshenShadowRenderLists})(TOB||(TOB={}));